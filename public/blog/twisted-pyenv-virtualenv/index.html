<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Easy Twisted development with virtualenv and pyenv &middot; My Name</title>
        <meta name="description" content="Chris Wolfe">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.15" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://derwolfe.netcss/normalize.css">
        <link rel="stylesheet" href="https://derwolfe.netcss/highlight.css">
        <link rel="stylesheet" href="https://derwolfe.netcss/style.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    </head>
    <body>
        
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-41763159-1', 'auto');
ga('send', 'pageview');
</script>


        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a title="Easy Twisted development with virtualenv and pyenv" href="https://derwolfe.net">Easy Twisted development with virtualenv and pyenv</a>
                            </h1>
                        
                        <a class="button-square" href="https://derwolfe.netindex.xml"><i class="fa fa-rss"></i></a>
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" title="Twitter" href="https://twitter.com/chriswwolfe">
                                <i class="fa fa-twitter"></i>
                            </a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/derwolfe">
                                <i class="fa fa-github-alt"></i>
                            </a>
                        
                        
                        
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Blog" href="/">Blog</a>
    </li>

    <li class="site-nav-item">
        <a title="Projects" href="/project/">Projects</a>
    </li>

    <li class="site-nav-item">
        <a title="Contact" href="/page/contact/">Contact</a>
    </li>

    <li class="site-nav-item">
        <a title="About" href="/page/about/">About</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">

<div class="container">
    <article class="post-container">
        <header class="post-header">
    <h1 class="post-title">Easy Twisted development with virtualenv and pyenv</h1>
    
</header>

        <div class="post-content clearfix">
    

    

<p>This is meant as a how-to for programmers
interested in developing the <a href="https://www.twistedmatrix.com">Twisted networking
library</a> using virtualenvs. I&rsquo;m assuming
you&rsquo;re working from a linux/unix based development environment. At a
later date, I&rsquo;ll see if the same setup can be used on windows.</p>

<h1 id="the-goal:97dc9d540082aac69de0e16d7994c1ee">The goal</h1>

<p>Create isolated development environments that target different
interpreters and require different dependencies.</p>

<h1 id="the-problem:97dc9d540082aac69de0e16d7994c1ee">The problem</h1>

<p>When using python to develop a project, it is very easy to accidentally
install packages that can be found by your system python. This is a
problem because it makes it difficult to isolate dependencies on a per
project basis. A better approach is to create isolated environments in
which dependencies can be installed.</p>

<p><a href="https://virtualenv.pypa.io/en/latest/virtualenv.html">Virtualenv</a> is a
tool that creates isolated python environments. When using a virtualenv,
pip installs dependencies into a location that is only visible to the
virtualenv. Virtualenvs are wonderful because you can test out different
versions of libraries without worring about accidentally upgrading a
dependency that would affect another project.</p>

<p>With python 2, one needed to install the virtualenv application to be
able to use it, in python3 it is baked in to the standard installation.
However, the method I&rsquo;m suggesting you use doesn&rsquo;t require you to
install virtualenv yourself.</p>

<p>By default, virtualenv is setup to target a specific python interpreter,
normally the one that is available in your <code>$PATH</code> environment variable.
This means that whatever python is in your path, is the python that will
be used when creating your virtualenv. While this is helpful, it only
solves the problem of being able to install dependencies in an isolated
environment. It doesn&rsquo;t solve the problem of a user wanting to target a
different interpreter that is installed on the host system. This is
where pyenv comes in.</p>

<h1 id="pyenv:97dc9d540082aac69de0e16d7994c1ee">Pyenv</h1>

<p><a href="https://github.com/yyuu/pyenv">Pyenv</a> manages the installation and
removal of python interpreters. Instead of needing to manually
manipulate your \$PATH to switch to a different interpreter, pyenv
allows you to specify which python you would like to use. For example,
to find and install pypy (with pyenv installed) you only need to type
the following:</p>

<pre><code class="language-sourceCode bash"># displays a list of python version names
$ pyenv install -l | grep pypy

# select the pypy version you'd like to install
$ pyenv install pypy-2.4.0
</code></pre>

<p>Once this command completes, pypy-2.4.0 will be installed. You can
access a new pypy shell by typing</p>

<pre><code class="language-console">$ pyenv shell pypy-2.4.0
</code></pre>

<p>This is an improvement as you no longer have to manually manipulate your
path in order to switch versions. But, if you are not careful, you can
still relatively easily install what would be system level dependencies.
(By this I mean, you can still install a package at the pypy-2.4.0
env-level). Luckily, there is a tool that makes it easy to create
virtualenvs using your pyenvs.</p>

<h1 id="pyenv-virtualenv:97dc9d540082aac69de0e16d7994c1ee">Pyenv-virtualenv</h1>

<p><a href="https://github.com/yyuu/pyenv-virtualenv">Pyenv-virtualenv</a> allows you
to create a virtualenv that will use a specific interpreter.</p>

<pre><code class="language-console">$ pyenv virtualenv 2.7.8 twisted278
</code></pre>

<p>The command creates a new virtualenv named <code>twisted278</code> which uses the
the <code>python 2.7.8</code> interpreter. If you wanted to create a new virtualenv
for python 3, without having python 3 installed, you would do the
following.</p>

<pre><code class="language-console"># find the python version you'd like to install
$ pyenv install -l

# 3.3.5 looks right, install it
$ pyenv install 3.3.5

# make a new virtualenv
$ pyenv virtualenv 3.3.5 twisted336
</code></pre>

<p>Note, it isn&rsquo;t required to append the name of your interpreter to the
virtualenv. I use this convention to make it easy to see which
interpreter I&rsquo;m actually targeting.</p>

<h1 id="twisted-relevancy:97dc9d540082aac69de0e16d7994c1ee">Twisted relevancy</h1>

<p>As part of the <a href="https://twistedmatrix.com/trac/wiki/Plan/Python%203">Twisted porting
process</a>, all
Twisted code must be verified to work on python 2.6, python 2.7, and
python 3.3. Using pyenv and virtualenv you can create a set of
environments from which all of the tests can be run.</p>

<p>If you are using a mac and have homebrew installed, installing pyenv and
pyenv-virtualenv is extremely easy, simply do</p>

<pre><code class="language-console">$ brew install pyenv pyenv-virtualenv
</code></pre>

<p>If you are using linux, you should follow the directions specified on
the <a href="https://github.com/yyuu/pyenv#installation">project website</a>.</p>

<p>As of right now, you should install python interpreters 2.6.9, 2.7.8 and
3.3.5. This can be done with the following command</p>

<pre><code class="language-console">$ pyenv install 2.6.9 2.7.8 3.3.5
</code></pre>

<p>Once these have installed successfully, you can create the virtualenvs
using the following commands. It does not matter in what directory these
commands are executed.</p>

<pre><code class="language-console">$ pyenv virtualenv 2.6.9 twisted269
$ pyenv virtualenv 2.7.8 twisted278
$ pyenv virtualenv 3.3.5 twisted335
</code></pre>

<p>This will create three new virtualenvs inside of ~/.pyenv/versions</p>

<p>Navigate to where ever your Twisted repository is stored, mine, for
example, is stored in ~/Code/twisted. If you are using bash or zsh, you
can run the activate script for each of the environments using the
following command</p>

<pre><code class="language-console">$ source ~/.pyenv/versions/twisted269/bin/activate
</code></pre>

<p>Once you&rsquo;ve activated the virtualenv, you can verify which interpreter
is targeting using the following.</p>

<pre><code class="language-console">(twisted269)$ python -v
Python 2.6.9
(twisted269)$ which python
/Users/chris/.pyenv/versions/twisted269/bin/python
</code></pre>

<p>Once the virtualenvs have been created, you can begin installing any
dependencies you might need. At a bare minimum, Twisted&rsquo;s test suite
requires zope.interface to be installed. This will need to be installed
in each of the virtualenvs in which you would like to run tests. I
handle this, by creating a requirements.txt file and filling it with the
dependencies I want to install in each virtualenv.</p>

<pre><code class="language-sourceCode bash">$ cd ~/Code/twisted
$ echo &quot;zope.interface&quot; &gt; requirements.txt
$ pip install -r requirements.txt
</code></pre>

<p><strong>Shameless plug</strong> - <del>if you&rsquo;d like Twisted to use the extra_requires
syntax available from setuptools to install optional dependencies, you
could review <a href="https://twistedmatrix.com/trac/ticket/3696">ticket #3696</a>!</del>
It was merged in Twisted 15.1. Yay!</p>

<p>To install the dependencies listed in the requirements.txt file, execute
the following commands in each virtualenv.</p>

<pre><code class="language-console">$ cd ~/Code/twisted
$ echo &quot;zope.interface&quot; &gt; requirements.txt

# install zope.interface into the twisted269 virtualenv
$ source ~/.pyenv/versions/twisted269/bin/activate
(twisted269)$ pip install -r requirements.txt
(twisted269)$ deactivate

# install zope.interface into the twisted278 virtualenv
$ source ~/.pyenv/versions/twisted278/bin/activate
(twisted278)$ pip install -r requirements.txt
(twisted278)$ deactivate

# install zope.interface into the twisted335 virtualenv
$ source ~/.pyenv/versions/twisted335/bin/activate
(twisted335)$ pip3 install -r requirements.txt
(twisted335)$ deactivate
</code></pre>

<p>The benefit of having created each of these virtualenvs, is that you may
now run the test suite for each of the different interpreters. My
typical workflow is to have several terminal windows open, each using a
different virtualenv/pyenv combination. This way, if I make a change to
the source, I can run the tests for each interpreter one by one, without
having to constantly activate and deactivate virtualenvs.</p>

<p>To run the tests for python 2, you just enter the following</p>

<pre><code class="language-console">$ source ~/.pyenv/versions/twisted269/bin/activate
(twisted269)$ cd ~/Code/twisted
(twisted269)$ ./bin/trial twisted
</code></pre>

<p>The same goes for python 2.7.8.</p>

<p>For python3, the tests are run using a small utility script saved inside
of twisted/admin.</p>

<pre><code class="language-console">$ source ~/.pyenv/versions/twisted335/bin/activate
(twisted335)$ cd ~/Code/twisted
(twisted335)$ ./admin/run-python 3-tests
</code></pre>

<h1 id="issues:97dc9d540082aac69de0e16d7994c1ee">Issues</h1>

<p>If you haven&rsquo;t already noticed, the code to activate a virtualenv is
pretty verbose. I
<a href="http://virtualenvwrapper.readthedocs.org/en/latest/">Virtualenv-wrapper</a>
project can be used to simplify activating virtualenvs. I use the fish
shell and have defined a function to activate virtualenvs. The sad part
about the fish function is that is it only works with pyenvs that
provide an activate.fish command. Here is the code:</p>

<pre><code class="language-console">function actenv --description 'activate the virtualenv with the given name'
   . ~/.pyenv/versions/$argv/bin/activate.fish
end
</code></pre>

<h1 id="finishing-up:97dc9d540082aac69de0e16d7994c1ee">Finishing up</h1>

<p>If you have gotten this far and followed the examples, you should have
been able to create new virtualenvs that are pinned to specific
interpreters. You should also have been able to run tests for twisted
using these virtualenvs.</p>

</div>

        <footer class="post-footer clearfix">
    

    <div class="share">
        <a class="icon-twitter" href="http://twitter.com/share?text=Easy%20Twisted%20development%20with%20virtualenv%20and%20pyenv&url=https%3a%2f%2fderwolfe.net%2fblog%2ftwisted-pyenv-virtualenv%2f"
            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
            <i class="fa fa-twitter"></i>
            <span class="hidden">Twitter</span>
        </a>

        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fderwolfe.net%2fblog%2ftwisted-pyenv-virtualenv%2f"
            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
            <i class="fa fa-facebook"></i>
            <span class="hidden">Facebook</span>
        </a>

        <a class="icon-google-plus" href="https://plus.google.com/share?url=https%3a%2f%2fderwolfe.net%2fblog%2ftwisted-pyenv-virtualenv%2f"
           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
           <i class="fa fa-google-plus"></i>
            <span class="hidden">Google+</span>
        </a>
    </div>
</footer>
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="Easy Twisted development with virtualenv and pyenv" href="https://derwolfe.net">Easy Twisted development with virtualenv and pyenv</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2014 / Powered by <a href="http://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://derwolfe.netjs/jquery-1.11.3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
        <script src="https://derwolfe.netjs/jquery.fitvids.js"></script>
        <script src="https://derwolfe.netjs/scripts.js"></script>
    </body>
</html>

